# =============================================================================
# Routing Matrix — commands.toml
# =============================================================================
#
# Bead:    repomap-core-4r3
# Source:  Workflow discipline retrofit (repomap-core-4r3)
# Updated: 2026-02-21
#
# Structure: verb + noun → skill binding + tool invocation
# All paths verified against .kilocode/ contents on this branch.
#
# Skills:
#   "cli"    = Raw CLI command (no skill dir)
#   "native" = Kilo built-in tool (new_task, switch_mode, etc.)
#   Other    = .kilocode/skills/{skill_id}/SKILL.md
#
# =============================================================================

# ─── Schema Metadata ────────────────────────────────────────────────────────

[meta]
version = "1.0.0"
inventory_date = "2026-02-21"
source_bead = "repomap-core-4r3"
total_bindings = 50  # 45 atomic + 5 composite

# ─── Quality Gates (receipt_required = true via bounded_gate.py) ────────────

[commands.format_ruff]
verb = "format"
noun = "ruff"
skill = "cli"
tool = ".venv/bin/python -m ruff format --check ."
gate_wrapper = ".venv/bin/python .kilocode/tools/bounded_gate.py"
receipt_required = true

[commands.check_ruff]
verb = "check"
noun = "ruff"
skill = "cli"
tool = ".venv/bin/python -m ruff check ."
gate_wrapper = ".venv/bin/python .kilocode/tools/bounded_gate.py"
receipt_required = true

[commands.check_mypy]
verb = "check"
noun = "mypy"
skill = "cli"
tool = ".venv/bin/python -m mypy src"
gate_wrapper = ".venv/bin/python .kilocode/tools/bounded_gate.py"
receipt_required = true

[commands.test_pytest]
verb = "test"
noun = "pytest"
skill = "cli"
tool = ".venv/bin/python -m pytest -q"
gate_wrapper = ".venv/bin/python .kilocode/tools/bounded_gate.py"
receipt_required = true

# ─── Composite: Quality Gate ────────────────────────────────────────────────

[commands.gate_quality]
verb = "gate"
noun = "quality"
skill = "cli"
composite = ["format_ruff", "check_ruff", "check_mypy", "test_pytest"]
tool = ".venv/bin/python .kilocode/tools/bounded_gate.py"
receipt_required = true
notes = "Expands composite into sequential bounded_gate.py invocations"

# ─── Beads Task Tracking ───────────────────────────────────────────────────

[commands.sync_remote]
verb = "sync"
noun = "remote"
skill = "beads-local-db-ops"
tool = ".kilocode/tools/bd sync --no-push"
receipt_required = false
deprecated = true
notes = "No-op with Dolt backend. Use export_beads / import_beads for JSONL interchange."

[commands.sync_push]
verb = "sync"
noun = "push"
skill = "beads-local-db-ops"
tool = ".kilocode/tools/bd sync"
receipt_required = false
deprecated = true
notes = "No-op with Dolt backend. Use export_beads / import_beads for JSONL interchange."

[commands.export_beads]
verb = "export"
noun = "beads"
skill = "beads-local-db-ops"
tool = ".kilocode/tools/bd export -o .beads/issues.jsonl"
receipt_required = false
notes = "Export Dolt state to JSONL for cross-clone git interchange. .beads/issues.jsonl is tracked in git (un-ignored)."

[commands.import_beads]
verb = "import"
noun = "beads"
skill = "beads-local-db-ops"
tool = ".kilocode/tools/bd import --from-jsonl .beads/issues.jsonl"
receipt_required = false
notes = "Import JSONL into Dolt after cross-clone git pull"

[commands.claim_issue]
verb = "claim"
noun = "issue"
skill = "beads-local-db-ops"
tool = ".kilocode/tools/bd update {id} --status in_progress"
receipt_required = false

[commands.close_issue]
verb = "close"
noun = "issue"
skill = "beads-local-db-ops"
tool = ".kilocode/tools/bd close {id}"
receipt_required = false

[commands.show_issue]
verb = "show"
noun = "issue"
skill = "beads-local-db-ops"
tool = ".kilocode/tools/bd show {id}"
receipt_required = false

[commands.list_ready]
verb = "list"
noun = "ready"
skill = "beads-local-db-ops"
tool = ".kilocode/tools/bd ready"
receipt_required = false

[commands.diagnose_issues]
verb = "diagnose"
noun = "issues"
skill = "beads-local-db-ops"
tool = ".kilocode/tools/bd_doctor_safe.sh"
receipt_required = false

# ─── Code Search & Retrieval ───────────────────────────────────────────────

[commands.retrieve_codebase]
verb = "retrieve"
noun = "codebase"
skill = "repomap-codebase-retrieval"
tool = "mcp--augment___context___engine--codebase___retrieval"
receipt_required = false

[commands.query_docs]
verb = "query"
noun = "docs"
skill = "context7-docs-ops"
tool = "mcp--context7--query___docs"
receipt_required = false
notes = "Requires resolve_library first"

[commands.resolve_library]
verb = "resolve"
noun = "library"
skill = "context7-docs-ops"
tool = "mcp--context7--resolve___library___id"
receipt_required = false

# ─── SonarQube Inspection ──────────────────────────────────────────────────

[commands.search_issues]
verb = "search"
noun = "issues"
skill = "sonarqube-ops"
tool = "mcp--sonarqube--search_sonar_issues_in_projects"
receipt_required = false

[commands.inspect_quality_gate]
verb = "inspect"
noun = "quality-gate"
skill = "sonarqube-ops"
tool = "mcp--sonarqube--get_project_quality_gate_status"
receipt_required = false

[commands.inspect_measures]
verb = "inspect"
noun = "measures"
skill = "sonarqube-ops"
tool = "mcp--sonarqube--get_component_measures"
receipt_required = false

# ─── Structured Reasoning ──────────────────────────────────────────────────

[commands.decompose_task]
verb = "decompose"
noun = "task"
skill = "sequential-thinking-default"
tool = "mcp--sequentialthinking--process_thought"
receipt_required = false

[commands.summarize_thinking]
verb = "summarize"
noun = "thinking"
skill = "sequential-thinking-default"
tool = "mcp--sequentialthinking--generate_summary"
receipt_required = false

[commands.export_session]
verb = "export"
noun = "session"
skill = "sequential-thinking-default"
tool = "mcp--sequentialthinking--export_session"
receipt_required = false

[commands.import_session]
verb = "import"
noun = "session"
skill = "sequential-thinking-default"
tool = "mcp--sequentialthinking--import_session"
receipt_required = false

# ─── Orchestration: Generic ────────────────────────────────────────────────

[commands.spawn_subtask]
verb = "spawn"
noun = "subtask"
skill = "native"
tool = "new_task"
receipt_required = false
notes = "Requires mode slug and handoff packet"

# ─── Orchestration: Mode-Routed Dispatch ───────────────────────────────────
# Each dispatch entry maps to a specific mode target via new_task.

[commands.dispatch_fitter]
verb = "dispatch"
noun = "fitter"
skill = "native"
tool = "new_task"
target_mode = "fitter"
contract = ".kilocode/contracts/line_health/line_fault_contract.md"
receipt_required = false

[commands.dispatch_code]
verb = "dispatch"
noun = "code"
skill = "native"
tool = "new_task"
target_mode = "code"
contract = ".kilocode/contracts/composability/handoff_packet.md"
receipt_required = false

[commands.dispatch_architect]
verb = "dispatch"
noun = "architect"
skill = "native"
tool = "new_task"
target_mode = "architect"
contract = ".kilocode/contracts/composability/handoff_packet.md"
receipt_required = false

[commands.dispatch_docs]
verb = "dispatch"
noun = "docs-specialist"
skill = "native"
tool = "new_task"
target_mode = "docs-specialist"
contract = ".kilocode/contracts/composability/handoff_packet.md"
receipt_required = false

[commands.dispatch_product_skeptic]
verb = "dispatch"
noun = "product-skeptic"
skill = "native"
tool = "new_task"
target_mode = "product-skeptic"
contract = ".kilocode/contracts/composability/handoff_packet.md"
receipt_required = false

[commands.dispatch_code_simplifier]
verb = "dispatch"
noun = "code-simplifier"
skill = "native"
tool = "new_task"
target_mode = "code-simplifier"
contract = ".kilocode/contracts/composability/handoff_packet.md"
receipt_required = false

# ─── Orchestration: Thinker Mode Dispatch ──────────────────────────────────
# Thinker modes are composable thinking specialists with enforceable contracts.

[commands.dispatch_thinker_abstract]
verb = "dispatch"
noun = "thinker-abstract"
skill = "native"
tool = "new_task"
target_mode = "thinker-abstract"
contract = ".kilocode/contracts/thinking/abstract_thinking.md"
receipt_required = false

[commands.dispatch_thinker_adversarial]
verb = "dispatch"
noun = "thinker-adversarial"
skill = "native"
tool = "new_task"
target_mode = "thinker-adversarial"
contract = ".kilocode/contracts/thinking/adversarial_thinking.md"
receipt_required = false

[commands.dispatch_thinker_systems]
verb = "dispatch"
noun = "thinker-systems"
skill = "native"
tool = "new_task"
target_mode = "thinker-systems"
contract = ".kilocode/contracts/thinking/systems_thinking.md"
receipt_required = false

[commands.dispatch_thinker_concrete]
verb = "dispatch"
noun = "thinker-concrete"
skill = "native"
tool = "new_task"
target_mode = "thinker-concrete"
contract = ".kilocode/contracts/thinking/concrete_thinking.md"
receipt_required = false

[commands.dispatch_thinker_epistemic]
verb = "dispatch"
noun = "thinker-epistemic"
skill = "native"
tool = "new_task"
target_mode = "thinker-epistemic"
contract = ".kilocode/contracts/thinking/epistemic_thinking.md"
receipt_required = false

# ─── Plant Validation ──────────────────────────────────────────────────────

[commands.validate_plant]
verb = "validate"
noun = "plant"
skill = "cli"
tool = ".venv/bin/python .kilocode/tools/bounded_gate.py --gate-id workflow-validation -- .venv/bin/python .kilocode/tools/workflow_gate.py"
gate_wrapper = ".venv/bin/python .kilocode/tools/bounded_gate.py"
receipt_required = true

# ─── Session Monitoring ────────────────────────────────────────────────────

[commands.monitor_session]
verb = "monitor"
noun = "session"
skill = "cli"
tool = "python3 .kilocode/tools/kilo_session_monitor.py whoami"
receipt_required = false

[commands.inspect_cost]
verb = "inspect"
noun = "cost"
skill = "cli"
tool = "python3 .kilocode/tools/kilo_session_monitor.py cost"
receipt_required = false

[commands.inspect_timeline]
verb = "inspect"
noun = "timeline"
skill = "cli"
tool = "python3 .kilocode/tools/kilo_session_monitor.py timeline --last 20"
receipt_required = false

# ─── Punch Card Engine ──────────────────────────────────────────────────────

[commands.punch_mint]
verb = "mint"
noun = "punches"
skill = "cli"
tool = "python3 .kilocode/tools/punch_engine.py mint {task_id} --bead-id {bead_id}"
receipt_required = false
notes = "Extract events from task ui_messages.json and gate_runs.jsonl into punch_cards.punches (optional --bead-id for gate_runs matching)"

[commands.punch_evaluate]
verb = "evaluate"
noun = "punch-card"
skill = "cli"
tool = "python3 .kilocode/tools/punch_engine.py evaluate {task_id} {card_id}"
receipt_required = false
notes = "Check task punches against punch card requirements"

[commands.punch_checkpoint]
verb = "checkpoint"
noun = "punch-card"
skill = "cli"
tool = "python3 .kilocode/tools/punch_engine.py checkpoint {task_id} {card_id}"
receipt_required = true
notes = "Evaluate + create checkpoint; DOLT_COMMIT on pass"

# ─── PR Review ─────────────────────────────────────────────────────────────

[commands.fetch_pr]
verb = "fetch"
noun = "pr"
skill = "github-cli-code-review"
tool = "gh pr view --json number,title,body,reviewDecision,reviews,comments"
receipt_required = false

[commands.list_pr_comments]
verb = "list"
noun = "pr-comments"
skill = "github-cli-code-review"
tool = "gh pr view --json reviews,comments"
receipt_required = false

# ─── Composite: Address PR Feedback ────────────────────────────────────────

[commands.address_pr_feedback]
verb = "address"
noun = "pr-feedback"
skill = "github-cli-code-review"
composite = ["fetch_pr", "list_pr_comments", "inspect_quality_gate", "search_issues", "gate_quality"]
receipt_required = true
notes = """
Full PR address-and-respond cycle:
1. fetch_pr — pull PR metadata + review decision
2. list_pr_comments — extract unresolved review threads
3. inspect_quality_gate — check SonarQube quality gate status for the PR
4. search_issues — list SonarQube issues on the PR (with pullRequestId)
5. [agent implements fixes for reviewer comments + SonarQube issues]
6. gate_quality — run local quality gates before pushing
7. [agent pushes + responds to threads]
Steps 5 and 7 are agent-driven (not tool-bound).
"""

# ─── Composite: Land Plane (full session landing) ──────────────────────────

[commands.land_plane]
verb = "land"
noun = "plane"
skill = "beads-local-db-ops"
composite = ["gate_quality", "close_issue", "export_beads"]
tool = ".kilocode/tools/beads_land_plane.sh --bead-id {id}"
receipt_required = true
notes = "beads_land_plane.sh requires --bead-id; performs quality gates + bead closure"

# ─── Composite: Thinking Plan Execution ────────────────────────────────────
# Composable thinking plans chain thinker mode dispatches in sequence.

[commands.execute_thinking_plan]
verb = "execute"
noun = "thinking-plan"
skill = "native"
composite = ["dispatch_thinker_abstract", "dispatch_thinker_adversarial", "dispatch_thinker_concrete"]
notes = "Template. Actual plan comes from .kilocode/contracts/thinking/plans/*.md"
receipt_required = false

# ─── Composite: Dispatch Process Orchestrator ──────────────────────────────

[commands.dispatch_process_orchestrator]
verb = "dispatch"
noun = "process-orchestrator"
skill = "native"
tool = "new_task"
target_mode = "process-orchestrator"
contract = ".kilocode/contracts/composability/handoff_packet.md"
receipt_required = false
notes = "Tier 2 tactical orchestrator — lifecycle: discover→explore→prepare→execute→gate→land"

[commands.dispatch_audit_orchestrator]
verb = "dispatch"
noun = "audit-orchestrator"
skill = "native"
tool = "new_task"
target_mode = "audit-orchestrator"
contract = ".kilocode/contracts/composability/handoff_packet.md"
receipt_required = false
notes = "Tier 2 tactical orchestrator — adversarial pressure testing"

# ─── Factory Dispatch (kilo serve HTTP API) ──────────────────────────────────

[commands.factory_dispatch]
verb = "dispatch"
noun = "factory"
skill = "cli"
tool = ".kilocode/tools/factory_dispatch.sh"
notes = "First-class factory kickoff — creates session, sends prompt, monitors to completion"
receipt_required = false

[commands.factory_dispatch_attestation]
verb = "dispatch"
noun = "attestation"
skill = "cli"
tool = ".kilocode/tools/factory_dispatch.sh -m plant-manager .kilocode/prompts/attestation-health-check.json"
notes = "Run mode attestation health check across all 14 custom modes"
receipt_required = false

[commands.factory_dispatch_fire_and_forget]
verb = "dispatch"
noun = "factory-async"
skill = "cli"
tool = ".kilocode/tools/factory_dispatch.sh --no-monitor"
notes = "Fire-and-forget factory dispatch — prints session ID and exits"
receipt_required = false
